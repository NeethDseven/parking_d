/**
 * Application principale - Syst√®me de chargement des scripts (Version Consolid√©e)
 */

// √âviter les chargements multiples avec un guard pattern complet
(function () {
    'use strict';

    // V√©rification si l'app existe d√©j√†
    if (window.App && window.app && typeof window.app.init === 'function') {
        // App d√©j√† charg√©e, r√©utilisation de l'instance existante
        console.log('App d√©j√† charg√©e, r√©utilisation de l\'instance existante');
        return; // Sort de la fonction IIFE
    }

    // Si window.app existe mais est corrompu, le supprimer
    if (window.app && typeof window.app.init !== 'function') {
        console.warn('Instance window.app corrompue d√©tect√©e, r√©initialisation...');
        delete window.app;
    }

    // Initialisation de l'application...

    class App {
        constructor() {
            console.log('üöÄ Constructeur App appel√©');
            this.baseUrl = document.querySelector('meta[name="base-url"]')?.content || '/';
            this.page = '';  // Sera d√©fini dans init()
            this.loadedModules = new Set();
            this.components = {};
            this.services = {};
            console.log('‚úÖ Constructeur App termin√©');
        }

        /**
         * Initialise l'application avec l'architecture consolid√©e
         */
        async init() {
            console.log('üî• M√©thode init() appel√©e');
            // R√©cup√©rer la page active depuis la meta ou l'attribut data-page du body        
            this.page = document.querySelector('meta[name="current-page"]')?.content ||
                (document.body ? document.body.dataset.page : '') || '';

            console.log('üìÑ Page d√©tect√©e:', this.page);

            // Application initialis√©e silencieusement
            window.logger?.silent('Application initialis√©e - Page active:', this.page);

            // Charger uniquement les gestionnaires unifi√©s (ARCHITECTURE CONSOLID√âE)
            try {                // Gestionnaire unifi√© pour toutes les r√©servations (remplace tous les anciens composants)
                if (document.querySelector('meta[name="user-data"]') ||
                    this.page === 'places' ||
                    this.page === 'reservation') {
                    console.log('üîÑ Chargement unifiedReservationManager...');
                    await this.loadModule('components/unifiedReservationManager');
                }

                // Gestionnaire UI unifi√© pour les pages avec interactions dynamiques
                if (this.page === 'places' || this.page.startsWith('admin_')) {
                    console.log('üîÑ Chargement unifiedUIManager...');
                    await this.loadModule('components/unifiedUIManager');
                }

                // Script sp√©cifique pour la page places
                if (this.page === 'places') {
                    console.log('üîÑ Chargement script places...');
                    await this.loadModule('pages/places');
                }

                // Gestionnaires unifi√©s pour l'administration (remplacent tous les anciens composants admin)
                if (this.page.startsWith('admin_')) {
                    console.log('üîÑ Chargement modules admin...');
                    await this.loadModule('components/unifiedAdminManager');

                    // Script sp√©cifique pour le dashboard admin
                    if (this.page === 'admin_dashboard') {
                        console.log('üîÑ Chargement script dashboard admin...');
                        await this.loadModule('pages/admin-dashboard');
                    }
                }

                // Charger les d√©pendances sp√©cifiques √† la page (VERSION CONSOLID√âE)
                this.loadPageDependencies();

                console.log('‚úÖ Initialisation termin√©e avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                window.logger?.error('Erreur lors de l\'initialisation de l\'application:', error);
            }
        }        /**
         * Charge les d√©pendances n√©cessaires pour la page actuelle
         * VERSION CONSOLID√âE - Tous les composants ont √©t√© unifi√©s dans les gestionnaires
         */
        loadPageDependencies() {
            // ARCHITECTURE CONSOLID√âE: Tous les composants ont √©t√© unifi√©s
            // - unifiedReservationManager: g√®re toutes les fonctionnalit√©s de r√©servation, alertes, profil, abonnements
            // - unifiedAdminManager: g√®re toutes les fonctionnalit√©s d'administration
            // - unifiedUIManager: g√®re l'interface utilisateur admin

            // Plus de chargements individuels n√©cessaires - tout est consolid√© !
            window.logger?.silent(`Page ${this.page}: Utilisation de l'architecture consolid√©e`);

            // Validation post-chargement pour s'assurer que les gestionnaires sont op√©rationnels
            setTimeout(() => {
                this.validateLoadedComponents();
            }, 500);

            // Services globaux maintenant consolid√©s
            this.initializeBootstrapComponents();
        }

        /**
         * Valide que les composants charg√©s sont op√©rationnels
         */
        validateLoadedComponents() {
            if (this.page === 'places' && window.uiManager) {
                // V√©rifier que l'UI Manager est bien initialis√© pour la page places
                if (typeof window.uiManager.setupPlaces === 'function') {
                    console.log('‚úÖ UI Manager valid√© pour la page places');
                } else {
                    console.warn('‚ö† UI Manager non compl√®tement initialis√©');
                }

                // V√©rifier l'API de pagination
                if (window.directClickPagination && window.directClickPagination.loadPage) {
                    console.log('‚úÖ API de pagination disponible');
                } else {
                    console.warn('‚ö† API de pagination non disponible');
                }
            }
        }

        /**
         * Initialise les composants Bootstrap
         */
        initializeBootstrapComponents() {
            // Initialiser les tooltips et popovers Bootstrap
            setTimeout(() => {
                if (window.bootstrap) {
                    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                    [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

                    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
                    [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
                }
            }, 500);
        }

        /**
         * Charge un module (service ou composant)
         * @param {string} moduleName - Le nom du module √† charger
         * @returns {Promise} - Promise r√©solue quand le module est charg√©
         */
        async loadModule(moduleName) {
            if (this.loadedModules.has(moduleName)) {
                // Module ${moduleName} d√©j√† charg√©
                return true;
            }

            try {
                const moduleUrl = `${this.baseUrl}frontend/assets/js/${moduleName}.js`;

                const response = await fetch(moduleUrl);
                if (!response.ok) {
                    throw new Error(`Erreur de chargement du module ${moduleName}`);
                }

                const script = document.createElement('script');
                script.src = moduleUrl;
                script.async = true;

                const loadPromise = new Promise((resolve, reject) => {
                    script.onload = () => {
                        this.loadedModules.add(moduleName);
                        resolve(true);
                    };
                    script.onerror = () => {
                        reject(new Error(`Erreur de chargement du module ${moduleName}`));
                    };
                });

                document.head.appendChild(script);
                return await loadPromise;

            } catch (error) {
                window.logger?.error(`Erreur lors du chargement du module ${moduleName}:`, error);
                throw error;
            }
        }

        /**
         * Enregistre un composant
         * @param {string} name - Le nom du composant
         * @param {Object} component - L'instance du composant
         */
        registerComponent(name, component) {
            this.components[name] = component;
            window.logger?.debug(`Composant enregistr√©: ${name}`);
        }

        /**
         * Enregistre un service
         * @param {string} name - Le nom du service
         * @param {Object} service - L'instance du service
         */
        registerService(name, service) {
            this.services[name] = service;
            window.logger?.debug(`Service enregistr√©: ${name}`);
        }

        /**
         * R√©cup√®re un composant
         * @param {string} name - Le nom du composant
         * @returns {Object} - L'instance du composant
         */
        getComponent(name) {
            return this.components[name];
        }

        /**
         * R√©cup√®re un service
         * @param {string} name - Le nom du service
         * @returns {Object} - L'instance du service
         */
        getService(name) {
            return this.services[name];
        }

        /**
         * R√©cup√®re la page actuelle
         * @returns {string} - Le nom de la page actuelle
         */
        getCurrentPage() {
            return this.page;
        }

        /**
         * V√©rifie si un module est charg√©
         * @param {string} moduleName - Le nom du module
         * @returns {boolean} - True si le module est charg√©
         */
        isModuleLoaded(moduleName) {
            return this.loadedModules.has(moduleName);
        }
    }

    // Exporter globalement
    window.App = App;

    // Cr√©er l'instance globale et initialiser
    try {
        console.log('üèóÔ∏è Cr√©ation de l\'instance App...');
        window.app = new App();

        // V√©rifier que l'instance a bien la m√©thode init
        if (typeof window.app.init !== 'function') {
            console.error('‚ùå Erreur: window.app.init n\'est pas une fonction', window.app);
            return;
        }

        console.log('‚úÖ Instance App cr√©√©e avec succ√®s');

        // Initialiser quand le DOM est pr√™t
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('üìÑ DOM pr√™t, initialisation...');
                if (window.app && typeof window.app.init === 'function') {
                    window.app.init();
                } else {
                    console.error('‚ùå window.app ou window.app.init non disponible au moment de l\'initialisation');
                }
            });
        } else {
            console.log('üìÑ DOM d√©j√† pr√™t, initialisation imm√©diate...');
            if (window.app && typeof window.app.init === 'function') {
                window.app.init();
            } else {
                console.error('‚ùå window.app ou window.app.init non disponible');
            }
        }
    } catch (error) {
        console.error('‚ùå Erreur lors de la cr√©ation de l\'instance App:', error);
    }

})();
